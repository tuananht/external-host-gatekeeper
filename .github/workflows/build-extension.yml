name: Build Extension

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  discussions: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Build extension package
        run: npm run build

      - name: Capture build metadata
        run: echo "BUILD_DATE=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> "$GITHUB_ENV"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: external-host-extension
          path: dist/external-host-gatekeeper.zip
          retention-days: 30

      - name: Create Release (on main branch push)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: External Host Extension v${{ github.run_number }}
          body: |
            ## External Host Extension v${{ github.run_number }}

            **Build Information:**
            - Commit: `${{ github.sha }}`
            - Build Date: `${{ env.BUILD_DATE }}`
            - Workflow: ${{ github.workflow }}

            **Installation:**
            1. Download `dist/external-host-gatekeeper.zip`
            2. Extract the archive
            3. Open `chrome://extensions/`
            4. Enable "Developer mode"
            5. Click "Load unpacked" and select the extracted folder

            **Highlights:**
            - Monitors third-party hosts per site
            - Declarative blocking of disallowed hosts
            - Session-aware tracking with popup review UI

            **Changes in this build:**
            - See commit history for details
          files: dist/external-host-gatekeeper.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Summary
        run: |
          {
            echo "## Build Summary"
            echo "- ✅ Dependencies installed"
            echo "- ✅ Extension built"
            echo "- ✅ Artifact uploaded: dist/external-host-gatekeeper.zip"
            if [ "${{ github.ref }}" = "refs/heads/main" ] && [ "${{ github.event_name }}" = "push" ]; then
              echo "- ✅ Release created: v${{ github.run_number }}"
            fi
            echo ""
            echo "**Download:** Check the Artifacts section or Releases tab"
          } >> "$GITHUB_STEP_SUMMARY"
